language: python
python:
- '2.7'
env:
  global:
  - SONAR="1"
  - secure: lZAIr5j/83XLms3FBgugvgerPV5baQ1igFS6Cw7kZ/tGAySpzy1WbGrURd0yErx+WHGhdVP7MP4CEyk2LYVc3rTqyRzFG2IEC+jh2j7Sl6+oOWH4APQmlxENH5cQjS14EBx6KNQ3hFnCbkFmZLhWz9Oyji3/GU4HyCpVYy2Ajekp/VSoEY3+fdFbglH5y5s7vrOosFbxaUYV90V4U7ygHFR7jvRVQ9O3Wh8K1BTVwGShmy5QQLiT8yFqjUtbolF6O0tfp16vhh+D8l+xWfBVfN+638Yg5ZazH4o41tTv+2BJcNGFyjSBF0RvDUIT1OYZKzff4dVcjcEuSFuBiW8AfY2mwKpVXoAFpSt9cjivnDdYwgT0X5iBFgWLVSm2ndhnvDM05j9P4roz/gSXNioLNDfsyZ33eTuz1MSnarcOzFboi22NrOt725rws2MKvhqsdrxeIHYyOjifUpW2t0cVZT3UBByDh27I2xCQwe/SSGU1aAGM/i6HC/VZLY4gY9hjOUB4s1Coatvo/qv2k1Gf3X151cfAF3G88amsI/0NvdX7ZW9aLaNd2BMDUN+VpDlSn+QU1LdGep0ze6bPYFINuqFBtZrzwTJdHXGj7xKFSp3Dw0PnFDUyXXLlMAkVl1BGPXcUIP9j0zx2wY0MiGYlm75CNXgMvVp2bnvhvYrp6WY=
  - secure: BR80IDuqkNojKAkDQH1AuGqT2EG0lVaGU1ozNZmcI9FMtuXBLNrM2vqBD+QHIODuiCCo8CWwXBX/VkExknGLNKdmHj1k55oFtR+rSeN+nuXhICOKv+CPSvXBQbmq/VBcP7VUR1XbkjbIo3rd8QZoJD+7wbNKmd9EaYgjfMhdsuyJIY7+tJs5EgiIhDYPwBU5O5FteW4u1BQjoFKFFFhmOyXlmkppZBKJlnNg6cOKSLHsmetnCDcT8jLC8YRk31kceFh2NcEqPAcRzn1EuYX8LznOhrjfILa/DsiLrGYzccs9UHmiByB3PNXmqIo94umq61daTYE9+q8rHyvYNxZSJ6coCxvWt9GjoKrhAECEk4Glp27klLRJaPnUbDOF3JYnYAZk1hKKzBDXawR1nZte4B5ptxzPz8UNW8F41rpjJ3bsmtk0nGoxz9Bz/KLnqj+wsmMkAfrptf6mxOzq+9xjjsSvT58UdA1c3hDjYvbJcpO6DSScb/dz/BhGrTQ22pt9J7a7+DU+OZiRvcLY25qq+VPVlS1fTLcD0evNuc2MGgqQqWMgzqpjHxT4ibu1hnuItrixBIZTu26ILWi71uFNT/bATvP7RYicN0+NmjOOn/UxqyMUQ4NjtY6AYnDwphHuqCO5vVKQj+z9TPc+WGig6fRwRObLNKz/P4KfJzZXxqc=
  - secure: JVy3Mt3QRBtMp8ozoPTsvqFaY8x7/kT+EpqVW6QoalzgdLLTKGUKvPKD0Phl6J539v0I1MMlFtn3y/y4eMfjn2/3r2qDAvkE4JIrDkCkOYpJw4WYonyPi+v5+SdfZOm4TDkFHv6A8Zm28367bsa9rKz+UOfEPMqXeM4l8vmsbbhZcso85GNbK7RuRa4sB5k2PYC322552Cnn6wHxmOMhNNoJ70wkn8qwb+EN/UW8kyIJOko54KRE6NTVprnA3dNUXuDu6g0VXfVj9+93Ww2XrSpmnXUWzfMr9SOmtRqYWqI3OKeVezLPhqqVgHqIbbF2cEzCeG8+K6GioIfHVm+eSWX+rJAHepLfoxdzfuqn4biXsDIq6bh7zupVQminRG/nw04il2qfL0TAM+4JSWlp++lkx9HbxIgoFdnldOPpUj4hzOOx1oDSgoKrb2OuJfEBiLeIHc3NwKkhNJ76g3ceAhOBD/QQeTRvPAW7RmpzPgsEqt2LYW277VhT05t9U5PEqpjR9CAM37x2OilPCpPYobdxCgWUyS61HX50EJC/EvVn0b88f5+Mt7U0892YX+q8hG62x7cd/TPQOsAqLE/UL3SJwe4qGLp6LDm7jT/LfPdtiHcV42SpiA6TUWxYgJ/wOR254s2gGLFRxtdQHf0+SPGnYCzC4A8B/QLC6+E3zws=
  - secure: AE3FFovcTs3gTo7PGOCWl2WuIHdaHlvqTCPDSlTwDFzrQ3qNI6gQDFQPeHevcQzVM1V53NZFLOyyXO9pHIjWlmYNgBJpILmvR+cOJ7KjEYWl/2NyRfSajZroy7tCAq/g6cOIgxfHlTS0VxS3JK+ZGV/EZGI0kGZMaXk6/5CtGMUp5eDj3D/VP+btjy1ufj1nTte1Pq8SJsNcsqcXqf1fA/8hSKHCSD56PlnNu/bobybS31T8K1FaDOfapGgI6xtSarvgPCRok8uRGeAzQV2+VWxkPTxWUUAJJLcockq2mLbVPdW8Z0Oc4FC+cc0RUBuH4to3/8A+E9itpoDaSJbRJUSkFXJuxrkfm/Jb35qnBLELD3NBXCW07cDDulqB6Z6V47uU4XbX6jW9w7ZjiozRpyKkWo7p+fqUVK4TikkR/Rk0WBA4kMSUsM4gd8f5EDX3B/aH3UrXj/k8USH0HyZHpydzhhalqTgpivEeeNK5HJKdCDO4Wgl1brtHTi0ERKG/ylMcDAtmBiQjD5BpXKG+dGZI6GDDToEwW5msaeQdnrB/3SbdIIoRA7od28qCQ5AwspRpeEP0w8i1fX4WxxrOeAJY2rydgIQoba4dZmqDyj2bVJLqXnLCSf3LUrXxYfszqSnF5juEeXtsUsBuROilPyUdQTWNTgy7vCZpCZMS3mY=
  - secure: onaC9YzMfDTN477g+xsF0LO4hAfGNViJggE0vS17XGDPmAVB45ZOGHurNPWKFT9jfqEq1bPnFuLC6TvW4xhp2BI8QDecpmiXOlV3a0ppi0E+Vp66aVOUeFp7BKV7LB8DTq1tYFET8FbWmRfgKhOqKwX01R2ZkFQ13dOd+kp10HgjVeOuNs/qmCazpD59rNS0gDbWuTzVOAu4iLnEqmbFtzLHjcXdmWg0CC4i2uCWUW1m/KjSmRSx15JjZZiB81kdaZqvJwtz5eooGahb/ZZ+yLplm9H+vJxoBsGv88DqKJeUSXDCfmrROxywFFVObcULFWqaRIyJGRk6FIlqI7jb+2rb21cXA6d2fbbn8GUtjnTIp9lN+gCw/Ti9CQAj3jF1mbjohoK4Sx1bki/cUKh+VkW0hRzZqYw2i9+W+jajeIILQjqi1jt7i1OUMzSU1kTqaj9aXY1DuY76ap0U2g68fLc6c4jFW8b3YTKkvfFDOBZuSEHiS2m1nLjjfeADXZA5hOx4edINoQ6E8wa1M+s7BXYZyen1Ru64w6xNH0Nkntytwx3vF2Dtvgtpx0I4by9lI9kAA+qQ+Qfh5PU3O/q/Cz+va3tP7xsMURrp3TnpDRrp2USFQynLjmaNkO1ewy01F6DGwkn1AyP6DbMq6Aq6K85TO5wnlBONpC5fz3AL2fg=
  - secure: MCvopizfxhDC/Zt0NAAd7f6iy54Ah5/nEQdo3rxegIZeTQa+ljW+yOk0XtFD7X8sy89RNPQeoSUcctyyHNn4f+uEHqW3ffjQcD4D8m3qWZBsF8wuG9zGAADhYHkTgiTl1uLwhF3PBPDpXf6RFOL0L379sUzT5mh2InmQ4dUNoOdaru48uArGioSjyzrA8MeMiSeXX13BdTZ368SEGMavsrd6x6D+/9oQ2/JK8gQ1tOfK3y3klmKiK1DqnpZpSX2Is8lZCPv+cL0uowSiwp4jO4ZrTNk8v+y0Yc6g14AmXozXodDNqhhEq5PmseHDBL1HH7ZRJLR5jPiNKXSmfYpwKdVVDGwnMNGTrEiSLaAgnXsvr+bzYVkJEbUwapgTayV+G4mWPuu9YiDHeyOMysqyimqt9YsjZVosJs8l9zsoM9TndjMsw1XAhVYmThGL4rL65YEz6Lxg3JGl/aM2AcqAcf8HWqdmt4K828vzj0NtzY4aePj0sEC1tDl2fxNRAngF6zQ2Jwd/WrRuTqq4EBDM2nKcoyVTRmt3SHJdzHKqesOCUG21sBLEbteq55B9Wl8Mi6tLBXEMcsNFYYwttA2kjhs7C5zqyzTyUVvijQN2DEn9KHsdhMnzIq3gc5n15L5uLZZu8QvxARiXYBIsYtnoTMUWTzzz9VoDXXHDhGcJgvY=
before_install:
- wget http://repo1.maven.org/maven2/org/codehaus/sonar/runner/sonar-runner-dist/2.4/sonar-runner-dist-2.4.zip
- unzip sonar-runner-dist-2.4.zip
- mv sonar-runner-2.4 ${HOME}/sonar-runner-2.4
- rm ${HOME}/sonar-runner-2.4/conf/sonar-runner.properties
- echo -e "sonar.host.url=${SONAR_URL}\nsonar.jdbc.username=${SONAR_USER}\nsonar.jdbc.password=${SONAR_PASSWORD}\nsonar.jdbc.url=${SONAR_DBURL}"
  >> ${HOME}/sonar-runner-2.4/conf/sonar-runner.properties
install:
- pip install -r requirements.txt
script:
- flake8 openeobs_mobile
- flake8 tests
- pylint openeobs_mobile tests | tee pylint_output
after_script:
- coverage xml -o ${HOME}/build/NeovaHealth/openeobs-quality-assurance/coverage.xml
- echo -e "\nsonar.branch=${TRAVIS_BRANCH}" >> sonar-project.properties
- ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST -L 2000:localhost:2000 -L 6432:localhost:5432 -fN
- printf '{"branch":"%s","commit":"%s","pull_request":"%s","repository":{"name":"%s"}}' "$TRAVIS_BRANCH" "$TRAVIS_COMMIT" "$TRAVIS_PULL_REQUEST" "$TRAVIS_REPO_SLUG" > json.file
- pwd
- ls ./
- if [ "$SONAR" == "1"] ; then "${HOME}/sonar-runner-2.4/bin/sonar-runner" ; fi
- echo "Test result is ${TRAVIS_TEST_RESULT}" 
- if["$TRAVIS_TEST_RESULT" == "0"]; then curl -v ${TARGET_URL}:8080/$TARGET_JOB --user $TARGET_USER:$TARGET_PASSWORD -F json_file=@./json.file -F coverage_file=@/home/travis/build/NeovaHealth/openeobs-quality-assurance/coverage.xml -F json='{"parameter":[{"name":"json_payload","file":"json_file"}, {"name":"coverage_report","file":"coverage_file"}]}'; fi


